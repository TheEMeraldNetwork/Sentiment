name: ðŸ… TIGRO Sentiment Analysis Automation

on:
  # Manual trigger (for Update button)
  workflow_dispatch:
    inputs:
      send_email:
        description: 'Send email report after analysis'
        required: false
        default: 'false'
        type: choice
        options:
        - 'true'
        - 'false'
      
  # Daily schedule at 2:50 PM CET (13:50 UTC)
  schedule:
    - cron: '50 13 * * *'
  
  # Trigger on push to main (for testing)
  push:
    branches: [ main ]
    paths: 
      - 'scripts/**'
      - 'utils/**'
      - 'master name ticker.csv'

jobs:
  sentiment_analysis:
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ”„ Checkout Repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: ðŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
        
    - name: ðŸ“¦ Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: ðŸ”§ Configure Environment
      run: |
        echo "PYTHONPATH=${{ github.workspace }}:$PYTHONPATH" >> $GITHUB_ENV
        mkdir -p results database/sentiment/detailed database/sentiment/summary
        
    - name: ðŸ”‘ Setup API Keys Configuration
      run: |
        mkdir -p utils/config
        cat > utils/config/api_keys.json << EOF
        {
          "finnhub_api_key": "${{ secrets.FINNHUB_API_KEY }}",
          "alpha_vantage_api_key": "${{ secrets.ALPHA_VANTAGE_API_KEY }}",
          "gmail_email": "${{ secrets.GMAIL_EMAIL }}",
          "gmail_password": "${{ secrets.GMAIL_APP_PASSWORD }}"
        }
        EOF
        
    - name: ðŸ“Š Run Sentiment Analysis
      run: |
        echo "ðŸš€ Starting sentiment analysis for $(wc -l < 'master name ticker.csv') stocks..."
        python scripts/sentiment/sent_collect_data.py
        echo "âœ… Sentiment analysis completed"
        
    - name: ðŸ“ˆ Generate Dashboard
      run: |
        echo "ðŸŽ¨ Generating fresh dashboard..."
        python scripts/visualization/viz_dashboard_generator.py
        echo "âœ… Dashboard generation completed"
        
    - name: ðŸ“§ Send Email Report (if requested)
      if: ${{ github.event.inputs.send_email == 'true' || github.event_name == 'schedule' }}
      run: |
        echo "ðŸ“§ Sending email report..."
        python -c "
        from utils.email.report_sender import SentimentEmailSender
        import pandas as pd
        import os
        
        if os.path.exists('results/sentiment_summary_latest.csv'):
            df = pd.read_csv('results/sentiment_summary_latest.csv')
            sender = SentimentEmailSender()
            success = sender.send_email(df, test_mode=False)
            print(f'ðŸ“§ Email sent: {\"SUCCESS\" if success else \"FAILED\"}')
        else:
            print('âŒ No sentiment data found for email')
        "
        
    - name: ðŸŒ Update GitHub Pages
      run: |
        echo "ðŸŒ Updating GitHub Pages content..."
        
        # Copy main index.html to docs/
        cp index.html docs/index.html
        
        # Copy latest sentiment report to docs/
        LATEST_REPORT=$(ls -t results/sentiment_report_*.html 2>/dev/null | head -1)
        if [ -n "$LATEST_REPORT" ]; then
          cp "$LATEST_REPORT" docs/sentiment_report_latest.html
          echo "âœ… Updated sentiment_report_latest.html"
        fi
        
        # Copy latest CSV data
        if [ -f "results/sentiment_summary_latest.csv" ]; then
          cp results/sentiment_summary_latest.csv docs/sentiment_summary_latest.csv
        fi
        
    - name: ðŸ“Š Analysis Summary
      run: |
        echo "ðŸ“Š SENTIMENT ANALYSIS SUMMARY:"
        if [ -f "results/sentiment_summary_latest.csv" ]; then
          STOCK_COUNT=$(tail -n +2 "results/sentiment_summary_latest.csv" | wc -l)
          echo "âœ… Stocks analyzed: $STOCK_COUNT"
          
          # Count sentiment trends
          RISING=$(tail -n +2 "results/sentiment_summary_latest.csv" | awk -F',' '$5 > 0.1' | wc -l)
          DECLINING=$(tail -n +2 "results/sentiment_summary_latest.csv" | awk -F',' '$5 < -0.1' | wc -l)
          
          echo "ðŸ“ˆ Rising sentiment: $RISING stocks"
          echo "ðŸ“‰ Declining sentiment: $DECLINING stocks"
          echo "ðŸ“… Analysis timestamp: $(date)"
        else
          echo "âŒ No analysis results found"
        fi
        
    - name: ðŸ’¾ Commit and Push Results
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # Add all new files and changes
        git add -A
        
        # Check if there are changes to commit
        if git diff --staged --quiet; then
          echo "â„¹ï¸ No changes to commit"
        else
          # Get analysis stats for commit message
          STOCK_COUNT="unknown"
          TIMESTAMP=$(date "+%Y%m%d_%H%M%S")
          
          if [ -f "results/sentiment_summary_latest.csv" ]; then
            STOCK_COUNT=$(tail -n +2 "results/sentiment_summary_latest.csv" | wc -l)
          fi
          
          git commit -m "ðŸ¤– Automated Sentiment Analysis Update - $TIMESTAMP

          âœ… GitHub Actions Workflow Completed
          ðŸ“Š Stocks analyzed: $STOCK_COUNT
          ðŸ¤– FinBERT AI processing completed
          ðŸ“ˆ Dashboard updated with fresh data
          ðŸ“§ Email report: ${{ github.event.inputs.send_email || 'scheduled' }}
          
          ðŸŽ¯ Triggered by: ${{ github.event_name }}
          â° Timestamp: $(date)
          ðŸ”„ Workflow: sentiment_analysis.yml"
          
          git push
          echo "âœ… Results pushed to repository"
        fi
        
    - name: ðŸŽ‰ Workflow Complete
      run: |
        echo "ðŸŽ‰ TIGRO Sentiment Analysis Workflow Completed Successfully!"
        echo "ðŸŒ Dashboard: https://theemeraldnetwork.github.io/sentiment/"
        echo "ðŸ“Š Fresh data available within 2-3 minutes" 